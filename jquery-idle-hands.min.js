(function($){$.idleHands=function(userSettings){let defaultSettings={activityEvents:'click keypress scroll wheel mousewheel mousemove',applicationId:'idle-hands',dialogMessage:'Your session is about to expire due to inactivity.',dialogTimeRemainingLabel:'Time remaining',dialogTitle:'Session Expiration Warning',heartbeatUrl:window.location.href,heartRate:300,inactivityLogoutUrl:'https://www.google.com',inactivityDialogDuration:45,localStoragePrefix:null,logoutNowButtonText:'Logout Now',manualLogoutUrl:null,maxInactivitySeconds:600,stayLoggedInButtonText:'Stay Logged In'};let settings=$.extend({},defaultSettings,userSettings);let sessionStartTime;let heartbeatTimer;let inactivityTimer;let originalPageTitle=document.title;let localStorage={};let heartbeat=function(heartbeat_url){$.get(heartbeat_url)}
let startHeartbeatTimer=function(){heartbeatTimer=setInterval(heartbeat(settings.heartbeatUrl),(settings.heartRate*1000))}
let stopHeartbeatTimer=function(){clearInterval(heartbeatTimer)}
let checkInactivity=function(){let sessionStartTime=getSessionStartTime();let elapsedSeconds=Math.floor((Date.now()-sessionStartTime)/1000);let remainingSeconds=(settings.maxInactivitySeconds-elapsedSeconds);let secondsLabel=(remainingSeconds==1)?'second':'seconds';$('#'+settings.applicationId+'-time-remaining').text(remainingSeconds+' '+secondsLabel);if((elapsedSeconds>settings.maxInactivitySeconds)||!sessionStartTime){logout(settings.inactivityLogoutUrl)}else if(remainingSeconds<=settings.inactivityDialogDuration){$(document).off(settings.activityEvents,activityHandler);showDialog()}else{hideDialog()}}
let startInactivityTimer=function(){setSessionStartTime(Date.now());inactivityTimer=setInterval(checkInactivity,1000)};let stopInactivityTimer=function(){clearInterval(inactivityTimer)}
let restartInactivityTimer=function(){stopInactivityTimer();startInactivityTimer()}
let activityHandler=function(event){restartInactivityTimer()}
let initializeLocalStorage=function(){let config={namespace:settings.localStoragePrefix||settings.applicationId,keyDelimiter:'.'};localStorage.basil=new window.Basil(config)}
localStorage.set=function(key,value){localStorage.basil.set(key,value)}
localStorage.get=function(key){return localStorage.basil.get(key)}
localStorage.remove=function(key){localStorage.basil.remove(key)}
localStorage.flush=function(){localStorage.basil.reset()}
let setSessionStartTime=function(time){localStorage.set('sessionStartTime',time);sessionStartTime=time}
let getSessionStartTime=function(){return localStorage.get('sessionStartTime')}
let deleteSessionStartTime=function(){localStorage.remove('sessionStartTime')}
let setLogoutUrl=function(logoutUrl){localStorage.set('logoutUrl',logoutUrl)}
let getLogoutUrl=function(){return localStorage.get('logoutUrl')}
let flushLocalStorage=function(){localStorage.flush()}
let createDialog=function(){let dialogContainerStyle='display: none;'+'z-index: 1000;';let overlayStyle='position:fixed;'+'width: 100%;'+'height: 100%;'+'top: 0;'+'left: 0;'+'right: 0;'+'bottom: 0;'+'background-color: rgba(0, 0, 0, 0.25);'+'z-index: 1;';let dialogStyle='position: absolute;'+'top: 50%;'+'left: 50%;'+'transform: translate(-50%, -50%);'+'z-index: 2;'+'background-color: #ffffff;'+'border-radius: 4px;'+'padding: 4px;'+'min-width: 300px;'+"font-family: 'Verdana', sans-serif;"+'font-weight: 400;'+'box-shadow: 0px 0px 3px black;';let dialogTitleStyle='text-align: center;'+'background-color: #1484c8;'+'padding: 5px;'+'border-radius: 4px;'+'font-size: 1.2rem;'+'font-weight: 700;'+'color: #ffffff;';let dialogMessageContainerStyle='padding: 10px;';let dialogHrStyle='margin: 0 0 4px 0;'+'border: 1px solid silver;'+'border-top: none;';let dialogButtonStyle='width: 40%;'+'padding: 5px 0;'+'margin: 1% 5%;';let overlay='<div style="'+overlayStyle+'" id="'+settings.applicationId+'-overlay"></div>';let dialogTitle='<div style="'+dialogTitleStyle+'" id="'+settings.applicationId+'-dialog-title">'+settings.dialogTitle+'</div>';let dialogMessage='<div style="'+dialogMessageContainerStyle+'" id="'+settings.applicationId+'-message-container">'+'<p id="'+settings.applicationId+'-message">'+settings.dialogMessage+'</p>'+'<p>'+settings.dialogTimeRemainingLabel+': <span id="'+settings.applicationId+'-time-remaining"></span></p>'+'</div>';let dialog='<div style="'+dialogStyle+'" id="'+settings.applicationId+'-dialog">'+dialogTitle+dialogMessage+'<hr style="'+dialogHrStyle+'" />'+'<button style="'+dialogButtonStyle+'" id="'+settings.applicationId+'-stay-logged-in-button">'+settings.stayLoggedInButtonText+'</button>'+'<button style="'+dialogButtonStyle+'" id="'+settings.applicationId+'-logout-button">'+settings.logoutNowButtonText+'</button>'+'</div>';let dialogContainer='<div style="'+dialogContainerStyle+'" id="'+settings.applicationId+'">'+overlay+dialog+'</div>';$('body').append(dialogContainer);$('#'+settings.applicationId+'-stay-logged-in-button').on('click',function(event){event.stopPropagation();stayLoggedIn()});$('#'+settings.applicationId+'-logout-button').on('click',function(event){event.stopPropagation();logout(settings.manualLogoutUrl||settings.inactivityLogoutUrl)})}
let showDialog=function(){document.title=settings.dialogTitle;$('#'+settings.applicationId).show(function(){$('#'+settings.applicationId+' button').first().focus()})}
let hideDialog=function(){document.title=originalPageTitle;$('#'+settings.applicationId).hide()}
let logout=function(logoutUrl){if(!getLogoutUrl()){setLogoutUrl(logoutUrl)}
stopHeartbeatTimer();stopInactivityTimer();deleteSessionStartTime();$('#'+settings.applicationId+'-dialog').hide();window.location.href=getLogoutUrl()}
let stayLoggedIn=function(){flushLocalStorage();restartInactivityTimer();$(document).on(settings.activityEvents,activityHandler);hideDialog()}
let initialize=function(){initializeLocalStorage();flushLocalStorage();$(document).on(settings.activityEvents,activityHandler);createDialog();startHeartbeatTimer();startInactivityTimer()}
initialize()}}(jQuery))